---
title: "ICC Simulation Study - Results Report"
author: "Simulation Pipeline"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(knitr)
```

# Executive Summary

This report summarizes the results of the ICC simulation study:

1. **Paper 1**: ICC estimation methods for clustered survival data
2. **Paper 2**: Impact of ICC on statistical power and sample size requirements

---

# Paper 1: ICC Estimation Methods

```{r load-paper1}
p1 <- readRDS("results_optimized/paper1_ICC_ALL_RESULTS.rds")
```

## Overview

- **Total rows:** `r format(nrow(p1), big.mark = ",")`
- **Scenarios:** `r length(unique(p1$scenario_id))`
- **Designs:** `r paste(unique(p1$design), collapse = ", ")`
- **ICC methods:** `r length(unique(p1$Method))`
- **Replications per scenario:** 1,000

## Method Performance

Performance metrics across all scenarios (sorted by RMSE):

```{r paper1-performance}
p1_summary <- p1 %>%
  group_by(Method) %>%
  summarise(
    Bias = round(mean(Mean_ICC - icc_input, na.rm = TRUE), 4),
    RMSE = round(sqrt(mean((Mean_ICC - icc_input)^2, na.rm = TRUE)), 4),
    Coverage = paste0(round(100 * mean(Lower_95CI <= icc_input & Upper_95CI >= icc_input, na.rm = TRUE), 1), "%"),
    .groups = "drop"
  ) %>%
  arrange(RMSE)

kable(p1_summary, col.names = c("Method", "Bias", "RMSE", "Coverage (95% CI)"))
```

**Key findings:**

- **CoxME methods** (Gaussian frailty & discretized time) perform best with near-zero bias, lowest RMSE, and nominal coverage (~98%)
- Methods based on observed events/censoring indicators show higher bias and lower coverage
- Analytical Log-Weibull has the worst coverage (61%)

## Bias by ICC Level

```{r paper1-bias-icc}
bias_by_icc <- p1 %>%
  filter(Method %in% c("CoxME Gaussian frailty", "CoxME discretized time", 
                       "Martingale", "GLMM logit discretized")) %>%
  group_by(Method, icc_input) %>%
  summarise(Bias = round(mean(Mean_ICC - icc_input, na.rm = TRUE), 4), .groups = "drop") %>%
  pivot_wider(names_from = icc_input, values_from = Bias)

kable(bias_by_icc, col.names = c("Method", "ICC = 0.01", "ICC = 0.1", "ICC = 0.3"))
```

**Pattern:** Slight overestimation at low ICC (0.01), underestimation at high ICC (0.3).

## Visualization

```{r paper1-plot, fig.width=10, fig.height=6}
p1 %>%
  filter(Method %in% c("CoxME Gaussian frailty", "Martingale", 
                       "GLMM logit discretized", "Cox gamma frailty (NP)")) %>%
  ggplot(aes(x = factor(icc_input), y = Mean_ICC, fill = Method)) +
  geom_boxplot(alpha = 0.7) +
  facet_wrap(~icc_input, scales = "free_y", labeller = label_both) +
  labs(title = "ICC Estimates by Method and True ICC",
       x = "True ICC", y = "Estimated ICC") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

---

# Paper 2: Statistical Power

```{r load-paper2}
p2_ind <- readRDS("results_optimized/paper2_power_individual/power_results_individual_FINAL.rds")
p2_hosp <- readRDS("results_optimized/paper2_power_hospital/power_results_hospital_FINAL.rds")
```

## Overview

- **Individual design scenarios:** `r nrow(p2_ind)`
- **Hospital design scenarios:** `r nrow(p2_hosp)`
- **nsim per scenario:** 1,000

## Power by ICC Level (Individual Design)

```{r paper2-power-icc}
power_by_icc <- p2_ind %>%
  group_by(ICC = icc) %>%
  summarise(
    `Mean Power` = paste0(round(100 * mean(power, na.rm = TRUE), 1), "%"),
    `Mean Power (with DE)` = paste0(round(100 * mean(power_DE, na.rm = TRUE), 1), "%"),
    `Power Recovery` = paste0("+", round(100 * (mean(power_DE, na.rm = TRUE) - mean(power, na.rm = TRUE)), 1), "%"),
    .groups = "drop"
  )

kable(power_by_icc)
```

**Key finding:** Ignoring ICC leads to substantial power loss (up to 18% at ICC = 0.3). Applying the Design Effect correction recovers power to ~80% target.

## Design Effect Statistics

```{r paper2-de}
de_stats <- p2_ind %>%
  filter(icc > 0) %>%
  group_by(ICC = icc) %>%
  summarise(
    `Mean DE` = round(mean(DE, na.rm = TRUE), 1),
    `Max DE` = round(max(DE, na.rm = TRUE), 1),
    `Mean sample_size_DE` = format(round(mean(sample_size_DE, na.rm = TRUE)), big.mark = ","),
    .groups = "drop"
  )

kable(de_stats)
```

## Power Visualization

```{r paper2-plot, fig.width=10, fig.height=5}
p2_ind %>%
  filter(icc > 0, !is.na(power_DE)) %>%
  select(icc, sample_size, power, power_DE) %>%
  pivot_longer(cols = c(power, power_DE), names_to = "Type", values_to = "Power") %>%
  mutate(Type = ifelse(Type == "power", "Original", "With DE Correction")) %>%
  ggplot(aes(x = factor(icc), y = Power, fill = Type)) +
  geom_boxplot(alpha = 0.7) +
  geom_hline(yintercept = 0.8, linetype = "dashed", color = "red") +
  labs(title = "Statistical Power: Original vs DE-Corrected Sample Size",
       subtitle = "Red dashed line = 80% target power",
       x = "ICC", y = "Power") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2") +
  theme(legend.position = "bottom")
```

---

# Paper 2: Sample Size Requirements

```{r load-ss}
ss <- readRDS("results_optimized/paper2_SAMPLE_SIZE_ALL_RESULTS.rds")
```

## Overview

- **Total scenarios:** `r nrow(ss)`
- **Designs:** `r paste(unique(ss$design), collapse = ", ")`
- **Target power:** 80%

## Sample Size by ICC and Design

```{r ss-table}
ss_summary <- ss %>%
  filter(!is.na(sample_size)) %>%
  group_by(ICC = icc, Design = design) %>%
  summarise(
    `Mean N` = round(mean(sample_size)),
    `Median N` = round(median(sample_size)),
    .groups = "drop"
  )

kable(ss_summary)
```

## Sample Size by ICC and Number of Hospitals

```{r ss-hosp}
ss_by_hosp <- ss %>%
  filter(!is.na(sample_size)) %>%
  group_by(ICC = icc, Hospitals = num_hosp) %>%
  summarise(`Mean Sample Size` = round(mean(sample_size)), .groups = "drop") %>%
  pivot_wider(names_from = Hospitals, values_from = `Mean Sample Size`, names_prefix = "H=")

kable(ss_by_hosp)
```

**Key finding:** Higher ICC and more hospitals substantially increase required sample size for 80% power.

---

# Missing Data Analysis (NA Values)

## Power DE - NA Breakdown

```{r na-analysis}
na_summary <- tibble(
  Category = c(
    "ICC = 0 (DE not applicable)",
    "sample_size_DE <= 20,000 (calculated)",
    "sample_size_DE > 20,000 (from old run - bonus)",
    "sample_size_DE > 700,000 (skipped - NA)"
  ),
  Count = c(
    sum(p2_ind$icc == 0),
    sum(!is.na(p2_ind$power_DE) & p2_ind$icc > 0 & p2_ind$sample_size_DE <= 20000),
    sum(!is.na(p2_ind$power_DE) & p2_ind$icc > 0 & p2_ind$sample_size_DE > 20000),
    sum(is.na(p2_ind$power_DE) & p2_ind$icc > 0)
  ),
  Status = c("Expected NA", "Calculated", "Bonus (pre-cap)", "Skipped (unrealistic)")
)

kable(na_summary)
```

## Extreme Scenarios (NA with ICC > 0)

These 30 scenarios were skipped because they require unrealistic sample sizes:

```{r na-extreme}
extreme <- p2_ind %>%
  filter(icc > 0, is.na(power_DE)) %>%
  group_by(`Base N` = sample_size, Hospitals = num_hosp, ICC = icc) %>%
  summarise(
    Scenarios = n(),
    DE = round(first(DE), 1),
    `Required N` = format(first(sample_size_DE), big.mark = ","),
    .groups = "drop"
  ) %>%
  arrange(desc(as.numeric(gsub(",", "", `Required N`))))

kable(extreme)
```

**Note:** These scenarios would require 29,940 to 2,164,200 patients - clearly unrealistic for any real clinical trial. Correctly skipped.

---
 
# Conclusions

## Recommendations

1. **ICC Estimation Method:** Use **CoxME with Gaussian frailty** - best performance across all metrics

2. **Design Effect:** Essential for clustered trials
   - Ignoring ICC causes 4-18% power loss depending on ICC level
   - DE correction recovers nominal power

3. **Sample Size Planning:** Account for clustering
   - Higher ICC → substantially larger N required
   - More clusters → higher total N but better precision

## Data Quality Summary

| Component | Status | Details |
|-----------|--------|---------|
| Paper 1 ICC | Complete | 864 scenarios × 2 designs × 1,000 reps |
| Paper 2 Power | 96.1% | 30 extreme scenarios correctly skipped |
| Paper 2 Sample Size | Complete | 384 scenarios |

---

*Report generated: `r Sys.time()`*
